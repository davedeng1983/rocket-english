# 实时错题归因流程说明

## 🎯 核心改动

**从"提交后统一归因"改为"每答一题立即归因"**

## 📋 新的答题流程

### 1. 用户答题
```
用户选择答案 → 系统立即判断对错
```

### 2. 答对的情况
```
答对 → 显示绿色反馈 ✓
  ↓
用户可以点击"下一题"继续
```

### 3. 答错的情况
```
答错 → 显示红色反馈 ✗
  ↓
立即弹出错题归因对话框
  ↓
用户选择错误原因（生词/语法/逻辑）
  ↓
用户填写具体详情
  ↓
点击"确认"
  ↓
归因信息保存到临时数组
  ↓
自动跳转到下一题
```

### 4. 提交试卷
```
所有题目答完 → 点击"提交试卷"
  ↓
批量保存所有临时归因信息到数据库
  ↓
显示结果页面（不再弹出归因对话框）
```

## 🔑 关键实现点

### 1. 实时判断对错
- 在 `handleSelectAnswer` 中，用户选择答案后立即判断
- 保存对错状态到 `questionStatus` 状态中

### 2. 实时显示反馈
- 答对：显示绿色提示框 + 选项显示绿色边框
- 答错：显示红色提示框 + 用户答案显示红色 + 正确答案显示绿色

### 3. 立即弹出归因对话框
- 如果答错，立即设置 `showAttribution = true`
- 对话框显示当前错题的信息

### 4. 临时存储归因信息
- 使用 `pendingAttributions` 数组存储所有归因信息
- 等最后提交时统一保存到数据库

### 5. 自动跳转下一题
- 归因完成后，自动跳转到下一题
- 如果已经是最后一题，提示用户可以提交

## 📊 数据结构

### questionStatus
```typescript
{
  [questionId]: {
    isCorrect: boolean
    userAnswer: string
    correctAnswer: string
  }
}
```

### pendingAttributions
```typescript
Array<{
  questionId: string
  gapType: 'vocab' | 'grammar' | 'logic'
  gapDetail: string
  userAnswer: string
  correctAnswer: string
}>
```

## 🎨 UI 变化

### 答题界面
- 答对后：显示绿色提示框"答对了！✓"
- 答错后：显示红色提示框"答错了✗"
- 选项高亮：正确答案绿色边框，用户错误答案红色边框
- 已回答后，选项按钮被禁用，防止重复选择

### 归因对话框
- 在答题过程中弹出，而不是提交后
- 归因完成后自动关闭并跳转下一题

## ⚠️ 注意事项

1. **主观题处理**：对于主观题（textarea），目前是实时输入，可能需要添加"确认答案"按钮来判断对错
2. **跳转逻辑**：归因完成后自动跳转，给用户300ms的延迟以便看到反馈
3. **状态管理**：使用 `waitingForAttribution` 防止用户在等待归因时继续操作
4. **数据持久化**：所有归因信息在提交时统一保存，避免频繁的数据库操作

